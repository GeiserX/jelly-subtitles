<div id="jellySubtitlesConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox">
    <div data-role="content">
        <div class="content-primary">
            <h1>JellySubtitles</h1>
            <form id="jellySubtitlesConfigurationForm">
                <div class="selectContainer">
                    <label class="selectLabel" for="selectProvider">Subtitle Provider</label>
                    <select is="emby-select" id="selectProvider" name="SelectedProvider">
                        <option value="Whisper">Whisper (Local)</option>
                        <option value="Parakeet">Parakeet (Local)</option>
                        <option value="Custom">Custom Command</option>
                    </select>
                    <div class="fieldDescription">Select the AI provider to use for generating subtitles.</div>
                </div>

                <div class="inputContainer">
                    <label class="inputLabel inputLabelUnfocused" for="txtWhisperModelPath">Whisper Model Path</label>
                    <input type="text" id="txtWhisperModelPath" name="WhisperModelPath" />
                    <div class="fieldDescription">Absolute path to the Whisper model file (e.g., /models/ggml-base.bin).</div>
                </div>

                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label>
                        <input is="emby-checkbox" type="checkbox" id="chkEnableAutoGeneration" name="EnableAutoGeneration" />
                        <span>Enable Auto-Generation</span>
                    </label>
                    <div class="fieldDescription">Automatically generate subtitles for new media in enabled libraries.</div>
                </div>

                <div>
                    <button is="emby-button" type="submit" class="raised button-submit block">
                        <span>Save</span>
                    </button>
                </div>
            </form>

            <br />
            <h2>Subtitle Management</h2>
            <p>Select a library to view items and generate subtitles.</p>

            <div class="selectContainer">
                <label class="selectLabel" for="selectLibrary">Library</label>
                <select is="emby-select" id="selectLibrary">
                    <option value="">Select a Library...</option>
                </select>
            </div>

            <div id="mediaTableContainer" style="margin-top: 1em;">
                <table class="tblMediaInfo" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Media Name</th>
                            <th>Status</th>
                            <th>Type</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="mediaTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var JellySubtitlesConfig = {
            pluginId: '97124bd9-c8cd-4a53-a213-e593aa3fef52'
        };

        function loadLibraries() {
            ApiClient.ajax({
                type: 'GET',
                url: ApiClient.getUrl('Plugins/JellySubtitles/Libraries')
            }).then(function (libraries) {
                var select = document.querySelector('#selectLibrary');
                select.innerHTML = '<option value="">Select a Library...</option>';
                libraries.forEach(function (lib) {
                    var option = document.createElement('option');
                    option.value = lib.Id;
                    option.textContent = lib.Name;
                    select.appendChild(option);
                });
            }).catch(function (error) {
                console.error('Error loading libraries:', error);
            });
        }

        function loadLibraryItems(libraryId) {
            var tbody = document.querySelector('#mediaTableBody');
            if (!libraryId) {
                tbody.innerHTML = '<tr><td colspan="4">Select a library to view items.</td></tr>';
                return;
            }

            tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';

            ApiClient.ajax({
                type: 'GET',
                url: ApiClient.getUrl('Plugins/JellySubtitles/Libraries/' + libraryId + '/Items')
            }).then(function (items) {
                tbody.innerHTML = '';

                if (items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4">No items found in this library.</td></tr>';
                    return;
                }

                items.forEach(function (item) {
                    var row = document.createElement('tr');
                    
                    var nameCell = document.createElement('td');
                    nameCell.textContent = item.Name;
                    
                    var statusCell = document.createElement('td');
                    statusCell.innerHTML = '<span style="color: ' + (item.HasSubtitles ? '#52B54B' : '#CC7B19') + ';">' + 
                        (item.HasSubtitles ? 'Has Subtitles' : 'No Subtitles') + '</span>';
                    
                    var typeCell = document.createElement('td');
                    typeCell.textContent = item.Type;
                    
                    var actionsCell = document.createElement('td');
                    
                    var generateBtn = document.createElement('button');
                    generateBtn.setAttribute('is', 'emby-button');
                    generateBtn.className = 'raised';
                    generateBtn.innerHTML = '<span>Generate</span>';
                    generateBtn.onclick = function() { generateSubtitle(item.Id); };
                    
                    var statusBtn = document.createElement('button');
                    statusBtn.setAttribute('is', 'emby-button');
                    statusBtn.className = 'raised';
                    statusBtn.style.marginLeft = '0.5em';
                    statusBtn.innerHTML = '<span>Status</span>';
                    statusBtn.onclick = function() { checkStatus(item.Id); };
                    
                    actionsCell.appendChild(generateBtn);
                    actionsCell.appendChild(statusBtn);
                    
                    row.appendChild(nameCell);
                    row.appendChild(statusCell);
                    row.appendChild(typeCell);
                    row.appendChild(actionsCell);
                    tbody.appendChild(row);
                });
            }).catch(function (error) {
                console.error('Error loading library items:', error);
                tbody.innerHTML = '<tr><td colspan="4">Error loading items.</td></tr>';
            });
        }

        function generateSubtitle(itemId) {
            if (!confirm('Generate subtitles for this item? This may take a while.')) {
                return;
            }

            Dashboard.showLoadingMsg();
            ApiClient.ajax({
                type: 'POST',
                url: ApiClient.getUrl('Plugins/JellySubtitles/Items/' + itemId + '/Generate?language=en')
            }).then(function (result) {
                Dashboard.hideLoadingMsg();
                Dashboard.alert('Subtitle generation started. Check status in a few minutes.');
                var libraryId = document.querySelector('#selectLibrary').value;
                if (libraryId) {
                    setTimeout(function() { loadLibraryItems(libraryId); }, 2000);
                }
            }).catch(function (error) {
                Dashboard.hideLoadingMsg();
                console.error('Error generating subtitle:', error);
                Dashboard.alert('Error generating subtitle: ' + (error.message || 'Unknown error'));
            });
        }

        function checkStatus(itemId) {
            ApiClient.ajax({
                type: 'GET',
                url: ApiClient.getUrl('Plugins/JellySubtitles/Items/' + itemId + '/Status')
            }).then(function (status) {
                var message = 'Subtitle Status:\n';
                message += 'Has Generated Subtitle: ' + (status.HasGeneratedSubtitle ? 'Yes' : 'No');
                if (status.SubtitlePath) {
                    message += '\nPath: ' + status.SubtitlePath;
                }
                Dashboard.alert(message);
            }).catch(function (error) {
                console.error('Error checking status:', error);
                Dashboard.alert('Error checking status: ' + (error.message || 'Unknown error'));
            });
        }

        document.querySelector('#selectLibrary').addEventListener('change', function (e) {
            loadLibraryItems(e.target.value);
        });

        document.querySelector('#jellySubtitlesConfigurationForm').addEventListener('submit', function (e) {
            e.preventDefault();
            Dashboard.showLoadingMsg();

            ApiClient.getPluginConfiguration(JellySubtitlesConfig.pluginId).then(function (config) {
                config.SelectedProvider = document.querySelector('#selectProvider').value;
                config.WhisperModelPath = document.querySelector('#txtWhisperModelPath').value;
                config.EnableAutoGeneration = document.querySelector('#chkEnableAutoGeneration').checked;

                ApiClient.updatePluginConfiguration(JellySubtitlesConfig.pluginId, config).then(function () {
                    Dashboard.hideLoadingMsg();
                    Dashboard.processPluginConfigurationUpdateResult();
                });
            });
        });

        // Load on page show
        document.addEventListener('viewshow', function () {
            ApiClient.getPluginConfiguration(JellySubtitlesConfig.pluginId).then(function (config) {
                document.querySelector('#selectProvider').value = config.SelectedProvider || 'Whisper';
                document.querySelector('#txtWhisperModelPath').value = config.WhisperModelPath || '';
                document.querySelector('#chkEnableAutoGeneration').checked = config.EnableAutoGeneration || false;
            });
            loadLibraries();
        });
    </script>
</div>
